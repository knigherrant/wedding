<?php/** # plg_system_jvlike - JV Like # @version		1.0.0 # ------------------------------------------------------------------------ # author    PHPKungfu Solutions Co # copyright Copyright (C) 2014 phpkungfu.club. All Rights Reserved. # @license - http://www.gnu.org/licenses/gpl-2.0.html GNU/GPL or later. # Websites: http://www.phpkungfu.club # Technical Support:  http://www.phpkungfu.club/my-tickets.html-------------------------------------------------------------------------*/// No direct access to this filedefined('_JEXEC') or die('Restricted access');jimport('joomla.plugin.plugin');JFactory::getLanguage()->load('plg_system_jvlike', JPATH_ADMINISTRATOR);class plgSystemJVLike extends JPlugin{	function plgSystemJVLike( &$subject, $params ){		parent::__construct( $subject, $params );	}	public function onContentAfterDisplay($context, &$article, &$params, $limitstart){            $com = explode('.', $context);            $target = (array)$this->params->get('target');            $page = array('item','article','productdetails');            if(in_array($com[0], $target) && in_array($com[1], $page)){                $c = explode ('_', $com[0]);                $type = $c[1];                if($type =='virtuemart') $itemid = $article->virtuemart_product_id;                else  $itemid = $article->id;                $element = "jvLike-{$type}-".$itemid;                $likeButton = $this->loadTemplate($itemid, $element,$type);                $template = $this->params->get('templateCode');                $template = str_replace('{jvlike}', $likeButton, $template);                return $template;			            }	}        public function loadTemplate( $itemid, $element = 'jvLike-$type-$itemid',$type){		$document = JFactory::getDocument();		if(version_compare(JVERSION, '3.0', '<')) $document->addScript(JUri::root().'plugins/system/jvlike/assets/js/jquery.min.js');		else JHtml::_('Jquery.framework');		$document->addScript(JUri::root().'plugins/system/jvlike/assets/js/jquery.noconflict.js');		$document->addScript(JUri::root().'plugins/system/jvlike/assets/js/jvlike.js');		$document->addStyleSheet(JUri::root().'plugins/system/jvlike/assets/css/jvlike.css');		$user = JFactory::getUser();		$likes = $this->getLikes($type, (int)$itemid);		if($user->guest){			$title = JText::_('PLG_SYSTEM_JVLIKE_LOGIN_REQUIRE');			if($likes > 1) $label = JText::_('PLG_SYSTEM_JVLIKE_LIKES');			else  $label = JText::_('PLG_SYSTEM_JVLIKE_LIKE');		}elseif($this->checkUserLiked($user->id, $type, (int)$itemid)){			$title = JText::_('PLG_SYSTEM_JVLIKE_LIKED_DESC');			if($likes > 1) $label = JText::_('PLG_SYSTEM_JVLIKE_LIKES');			else  $label = JText::_('PLG_SYSTEM_JVLIKE_LIKED');		}else{			$title = JText::_('PLG_SYSTEM_JVLIKE_LIKE_DESC');			if($likes > 1) $label = JText::_('PLG_SYSTEM_JVLIKE_LIKES');			else  $label = JText::_('PLG_SYSTEM_JVLIKE_LIKE');		}		ob_start();		?>		<span class="jvlike">				<button id="<?php echo $element;?>" class="jvlikeBtn" href="javascript:void(0)" title="<?php echo $title;?>">					<span class="uk-icon-heart"></span>					<img class="jvlikeLoader" src="<?php echo JURI::root().'plugins/system/jvlike/assets/images/loader.gif';?>" style="display:none"/>					<span class="jvlikeCount"><?php echo $likes;?></span> 					<span class="jvlikeText"><?php echo $label;?></span> 				</button>							</span>		<?php 		$likeButton = ob_get_clean();		return $likeButton;	}	public function onAfterInitialise(){            $input = JFactory::getApplication()->input;            if($input->get('plg') == 'jvlike' && $input->getString('item')){                    list(, $type, $itemid) = explode('-', $input->getString('item'));                    $user = JFactory::getUser();	                    $userid = 	$user->id;		                    //Check Guest                    if($user->guest) $userid = $this->getClient();//			exit(json_encode(array('rs'=>false, 'msg'=>JText::_('PLG_SYSTEM_JVLIKE_LOGIN_REQUIRE'))));			                    //Check liked                    $liked = $this->checkUserLiked($userid, $type, $itemid);			                    //Unlike                    if($liked){                            $rs = $this->unlike($liked);                            if($rs === true) exit(json_encode(array('rs'=>true, 'title'=>JText::_('PLG_SYSTEM_JVLIKE_LIKE_DESC'), 'label'=>JText::_('PLG_SYSTEM_JVLIKE_LIKE'), 'likes'=>$this->getLikes($type, $itemid))));                            else exit(json_encode(array('rs'=>false, 'msg'=>$rs)));                    }                    //Like                    $rs = $this->like($userid, $type, $itemid);                    if($rs === true) exit(json_encode(array('rs'=>true, 'title'=>JText::_('PLG_SYSTEM_JVLIKE_LIKED_DESC'), 'label'=>JText::_('PLG_SYSTEM_JVLIKE_LIKED'), 'likes'=>$this->getLikes($type, $itemid))));                    else exit(json_encode(array('rs'=>false, 'msg'=>$rs)));						            }        }	public function onAfterRender()	{		$app = JFactory::getApplication();		if ($app->getName() != 'site' || $app->get('sef') == '0')		{			return true;		}		$input = $app->input;		$option = $input->getString('option');		$view = $input->getString('view');		if($option =='com_easyblog' && $view=='entry'){		}	}		public function getClient()	{		$ua = JFactory::getApplication()->client;		$uaString = $ua->userAgent;		$browserVersion = $ua->browserVersion;		$uaShort = str_replace($browserVersion, 'abcd', $uaString);		return md5(JUri::base() . $uaShort);	}	public function getLikes($type, $itemid){		$db = JFactory::getDbo();		$db->setQuery('SELECT count(id) FROM #__jvlike WHERE type='.$db->quote($type).' AND itemid='.$itemid);		return $db->loadResult();	}	public function checkUserLiked($userid, $type, $itemid){		$db = JFactory::getDbo();		$db->setQuery('SELECT id FROM #__jvlike WHERE type='.$db->quote($type).' AND itemid='.$itemid.' AND userid='.$db->quote($userid));		return $db->loadResult();	}	public function unlike($id){		$db = JFactory::getDbo();		$db->setQuery('DELETE FROM #__jvlike WHERE id='.$id);		if($db->query()) return true;		return $db->getErrorMsg();	}	public function like($userid, $type, $itemid){		$db = JFactory::getDbo();		$query = $db->getQuery(true);		$query->insert('#__jvlike')->set('itemid='.$itemid)->set('type='.$db->quote($type))->set('userid='.$db->quote($userid))->set('created='.$db->quote(JFactory::getDate()->toSql()));		$db->setQuery($query);		if($db->query()) return true;		return $db->getErrorMsg();	}}class jvLike{	public static function loadLike($itemid, $id,$type){		$jvlike = JPluginHelper::importPlugin('system', 'jvlike');		$dispatcher	= JDispatcher::getInstance();		$tmplLike = $dispatcher->trigger('loadTemplate',array($itemid, $id,$type));		return $tmplLike[0];	}}